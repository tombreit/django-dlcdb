{% extends "inventory/base_inventory.html" %}

{% load crispy_forms_tags %}


{% block extra_css %}
<style>
.tr-note td {
    border-top: 0;
    padding: 0;
}
.note-update-wrapper {
    padding: 1rem;
}
.note-update-form {
    max-width: 600px;
    margin: 0 auto;
}
.note-update-form textarea {
    height: 5rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script type="module">
    $('#id_room').select2({
        theme: 'bootstrap4',
    });


    ;(function () {

        const modal = new bootstrap.Modal(document.getElementById("modal"))

        htmx.on("htmx:afterSwap", (e) => {
        // Response targeting #dialog => show the modal
        if (e.detail.target.id == "dialog") {
            modal.show()
        }
        })

        htmx.on("htmx:beforeSwap", (e) => {
        // Empty response targeting #dialog => hide the modal
        if (e.detail.target.id == "dialog" && !e.detail.xhr.response) {
            modal.hide()
            e.detail.shouldSwap = false
        }
        })

        // Remove dialog content after hiding
        htmx.on("hidden.bs.modal", () => {
        document.getElementById("dialog").innerHTML = ""
        })

        const toastElement = document.getElementById("toast")
        const toastBody = document.getElementById("toast-body")
        const toast = new bootstrap.Toast(toastElement, { delay: 2000 })

        htmx.on("showMessage", (e) => {
            toastBody.innerText = e.detail.value
            toast.show()
        })
})()
</script>

{% include 'inventory/includes/qrvideo-jsinit.html' %}

{% endblock extra_js %}


{% block body %}

    {% include 'inventory/includes/qrvideo.html' %}
    {% include 'inventory/includes/inventory_progress.html' %}

    <hr>

    <div class="row">
        <div class="col-12 col-md-6">
            <h3>
                Rooms 
                <span class="badge badge-secondary">
                    {{ filter.qs|length }}
                </span>
            </h3>
        </div>
        <div class="col-12 col-md-6">
            {% comment %}
            <form 
                hx-get="."
                hx-target="#room-list-body" 
            >
                {% crispy filter.form %}
            </form>
            {% endcomment %}


            <form>
                <div class="form-group">
                    <div class="input-group ">
                        <input 
                            type="text" name="q" value="235" class="textinput form-control" id="id_q"
                            hx-trigger="keyup changed delay:500ms" 
                            placeholder="Search rooms..."
                            hx-get="." 
                            hx-target="#room-list-body" 
                        >
                        <span class="input-group-append">
                                <button class="btn btn-sm btn btn-outline-primary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </span>
                    </div>
               </div>
            </form>
        </div>
    </div>

    <table class="table table-hover">
        <thead>
            <tr>
                <th>Room</th>
                <th>Note</th>
                <th>Devices</th>
            </tr>
        </thead>

        <tbody id="room-list-body" hx-trigger="load, objectListChanged from:body" hx-get hx-params="*" hx-target="this">
            <tr>
                <td colspan="4">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                          <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </td>
              </tr>
        </tbody>
    </table>

    {% include 'inventory/includes/pagination.html' %}

    {% include 'inventory/includes/bootstrap/modal.html' with modal_id="switch_room_modal" modal_title="New room scanned" modal_body="Be sure to save the inventory of the current room before switching to a new room" modal_proceed_id="change_room" modal_proceed_text="Switch to room" %}

    {% include 'inventory/partials/bs_modal.html' %}
    {% include 'inventory/partials/bs_toast.html' %}
{% endblock body %}


{% comment %}
    <div class="col">
        <span id="cam-has-camera" style="display: none;"></span>
        <video muted playsinline id="qr-video" style="max-height: 200px; max-width: 200px;"></video>
    </div>

    <form method="get">
        <div class="input-group input-group-sm mb-3">
            {{ filter.form.q }}
            <div class="input-group-append">
                <button class="btn-sm btn btn-outline-primary" type="submit" id="search-room-button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </form>

    {% include 'inventory/includes/pagination.html' %}
{% endcomment %}